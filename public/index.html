<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Packaging Materials Inventory</title>
    
    <link href="/css/tailwind.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <div class="container mx-auto p-4 flex-grow">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Packaging Materials Inventory</h1>

        <div class="flex justify-end mb-4">
            <button id="addItemBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow-md">
                <i class="fas fa-plus"></i> Add Item
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <label for="dateShift" class="block text-sm font-medium text-gray-700">Date Shift:</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="text" id="dateShift" name="dateShift" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                    <button id="setDateBtn" class="ml-2 inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Set Date
                    </button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-md">
                <label for="timeCounted" class="block text-sm font-medium text-gray-700">Time Counted:</label>
                <div class="mt-1 flex rounded-md shadow-sm">
                    <input type="text" id="timeCounted" name="timeCounted" class="focus:ring-blue-500 focus:border-blue-500 block w-full rounded-md sm:text-sm border-gray-300">
                    <button id="setTimeBtn" class="ml-2 inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Set Time
                    </button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between">
                <input type="file" id="importCountsFile" accept=".xlsx, .xls" class="hidden">
                <button id="importCountsBtn" class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow-md">
                    <i class="fas fa-file-import"></i> Import Counts
                </button>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between">
                <button id="exportExcelBtn" class="w-full bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded shadow-md">
                    <i class="fas fa-file-export"></i> Export
                </button>
            </div>
        </div>

        <div class="inventory-table-container bg-white p-4 rounded-lg shadow-md">
            <table id="inventoryTable" class="inventory-table min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Code</th>
                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Previous Count</th>
                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actual Count</th>
                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variance</th>
                        <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="itemModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeItemModalBtn">&times;</span>
            <h2 class="modal-title" id="modalTitle">Add New Item</h2>
            <form id="itemForm">
                <input type="hidden" id="itemId">
                <div class="form-group">
                    <label for="itemName">Item Name:</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label for="itemCode">Item Code:</label>
                    <input type="text" id="itemCode" required>
                </div>
                <div class="form-group">
                    <label for="previousCount">Previous Count:</label>
                    <input type="number" id="previousCount" value="0" required>
                </div>
                <div class="form-group">
                    <label for="actualCount">Actual Count:</label>
                    <input type="number" id="actualCount" value="0" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="save-btn"><i class="fas fa-save"></i> Save</button>
                    <button type="button" class="cancel-btn" id="cancelItemBtn"><i class="fas fa-times-circle"></i> Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="previewSelectionModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closePreviewSelectionModalBtn">&times;</span>
            <h2 class="modal-title">Preview Options</h2>
            <p class="mb-4">Select the columns you want to include in the preview:</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label class="block">
                    <input type="checkbox" id="previewItemName" checked class="mr-2"> Item Name
                </label>
                <label class="block">
                    <input type="checkbox" id="previewItemCode" checked class="mr-2"> Item Code
                </label>
                <label class="block">
                    <input type="checkbox" id="previewPreviousCount" checked class="mr-2"> Previous Count
                </label>
                <label class="block">
                    <input type="checkbox" id="previewActualCount" checked class="mr-2"> Actual Count
                </label>
                <label class="block">
                    <input type="checkbox" id="previewVariance" checked class="mr-2"> Variance
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" class="save-btn" id="generatePreviewBtn"><i class="fas fa-eye"></i> Generate Preview</button>
                <button type="button" class="cancel-btn" id="cancelPreviewBtn"><i class="fas fa-times-circle"></i> Cancel</button>
            </div>
        </div>
    </div>

    <footer class="mt-8 py-4 text-center text-gray-600 text-sm">
        <p>&copy; 2024 Packaging Materials Inventory. All rights reserved.</p>
    </footer>

    <script>
        // DOM Elements
        const addItemBtn = document.getElementById('addItemBtn');
        const itemModal = document.getElementById('itemModal');
        const closeItemModalBtn = document.getElementById('closeItemModalBtn');
        const cancelItemBtn = document.getElementById('cancelItemBtn');
        const itemForm = document.getElementById('itemForm');
        const modalTitle = document.getElementById('modalTitle');
        const itemIdInput = document.getElementById('itemId');
        const itemNameInput = document.getElementById('itemName');
        const itemCodeInput = document.getElementById('itemCode');
        const previousCountInput = document.getElementById('previousCount');
        const actualCountInput = document.getElementById('actualCount');
        const inventoryTableBody = document.getElementById('inventoryTableBody');

        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const importCountsFile = document.getElementById('importCountsFile');
        const importCountsBtn = document.getElementById('importCountsBtn');

        const dateShiftInput = document.getElementById('dateShift');
        const timeCountedInput = document.getElementById('timeCounted');
        const setDateBtn = document.getElementById('setDateBtn');
        const setTimeBtn = document.getElementById('setTimeBtn');

        const previewSelectionModal = document.getElementById('previewSelectionModal');
        const closePreviewSelectionModalBtn = document.getElementById('closePreviewSelectionModalBtn');
        const generatePreviewBtn = document.getElementById('generatePreviewBtn');
        const cancelPreviewBtn = document.getElementById('cancelPreviewBtn');

        let items = [];
        let currentItemId = null; // Used for editing

        // Modal Functions
        function openItemModal() {
            itemModal.classList.remove('hidden');
        }

        function closeItemModal() {
            itemModal.classList.add('hidden');
            itemForm.reset();
            modalTitle.textContent = 'Add New Item';
            itemIdInput.value = '';
            currentItemId = null;
        }

        function openPreviewSelectionModal() {
            previewSelectionModal.classList.remove('hidden');
        }

        function closePreviewSelectionModal() {
            previewSelectionModal.classList.add('hidden');
        }

        // Event Listeners for Modals
        addItemBtn.addEventListener('click', () => {
            modalTitle.textContent = 'Add New Item';
            openItemModal();
        });
        closeItemModalBtn.addEventListener('click', closeItemModal);
        cancelItemBtn.addEventListener('click', closeItemModal);

        // Close modal when clicking outside of it
        window.addEventListener('click', (event) => {
            if (event.target === itemModal) {
                closeItemModal();
            }
            if (event.target === previewSelectionModal) {
                closePreviewSelectionModal();
            }
        });

        // Item Form Submission
        itemForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const itemName = itemNameInput.value.trim();
            const itemCode = itemCodeInput.value.trim();
            const previousCount = parseInt(previousCountInput.value);
            const actualCount = parseInt(actualCountInput.value);

            if (!itemName || !itemCode) {
                alert('Item Name and Item Code are required.');
                return;
            }

            const variance = actualCount - previousCount;

            if (currentItemId) {
                // Edit existing item
                const index = items.findIndex(item => item.id === currentItemId);
                if (index !== -1) {
                    items[index] = { id: currentItemId, itemName, itemCode, previousCount, actualCount, variance };
                }
            } else {
                // Add new item
                const newItem = {
                    id: Date.now(), // Simple unique ID
                    itemName,
                    itemCode,
                    previousCount,
                    actualCount,
                    variance
                };
                items.push(newItem);
            }

            saveToLocal();
            renderTable();
            closeItemModal();
        });

        // Render Table
        function renderTable() {
            inventoryTableBody.innerHTML = ''; // Clear existing rows
            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2 px-4"><input type="checkbox" data-item-id="${item.id}" class="item-checkbox"></td>
                    <td class="py-2 px-4">${item.itemName}</td>
                    <td class="py-2 px-4">${item.itemCode}</td>
                    <td class="py-2 px-4">${item.previousCount}</td>
                    <td class="py-2 px-4">${item.actualCount}</td>
                    <td class="py-2 px-4 ${item.variance !== 0 ? (item.variance > 0 ? 'text-green-600' : 'text-red-600') : 'text-gray-600'}">${item.variance}</td>
                    <td class="py-2 px-4">
                        <button class="edit-btn" data-id="${item.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="delete-btn" data-id="${item.id}"><i class="fas fa-trash-alt"></i> Delete</button>
                    </td>
                `;
                inventoryTableBody.appendChild(row);
            });

            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => editItem(parseInt(event.currentTarget.dataset.id)));
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (event) => deleteItem(parseInt(event.currentTarget.dataset.id)));
            });
        }

        // Edit Item
        function editItem(id) {
            const item = items.find(item => item.id === id);
            if (item) {
                currentItemId = item.id;
                modalTitle.textContent = 'Edit Item';
                itemIdInput.value = item.id;
                itemNameInput.value = item.itemName;
                itemCodeInput.value = item.itemCode;
                previousCountInput.value = item.previousCount;
                actualCountInput.value = item.actualCount;
                openItemModal();
            }
        }

        // Delete Item
        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                items = items.filter(item => item.id !== id);
                saveToLocal();
                renderTable();
            }
        }

        // Local Storage
        function saveToLocal() {
            localStorage.setItem('inventoryItems', JSON.stringify(items));
        }

        function loadFromLocal() {
            const storedItems = localStorage.getItem('inventoryItems');
            if (storedItems) {
                items = JSON.parse(storedItems);
            }
        }

        // Export to Excel
        exportExcelBtn.addEventListener('click', () => {
            openPreviewSelectionModal();
        });

        generatePreviewBtn.addEventListener('click', async () => {
            const selectedColumns = {
                itemName: document.getElementById('previewItemName').checked,
                itemCode: document.getElementById('previewItemCode').checked,
                previousCount: document.getElementById('previewPreviousCount').checked,
                actualCount: document.getElementById('previewActualCount').checked,
                variance: document.getElementById('previewVariance').checked
            };

            const selectedItems = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(checkbox => {
                const id = parseInt(checkbox.dataset.itemId);
                return items.find(item => item.id === id);
            }).filter(Boolean); // Filter out any undefined items

            if (selectedItems.length === 0) {
                alert("Please select at least one item to preview.");
                return;
            }

            const excelData = [
                ["Date Shift", dateShiftInput.value],
                ["Time Counted", timeCountedInput.value],
                [], // Empty row for spacing
                // Headers based on selected columns
                Object.keys(selectedColumns).filter(key => selectedColumns[key]).map(key => {
                    // Convert camelCase to Title Case for headers
                    switch(key) {
                        case 'itemName': return 'Item Name';
                        case 'itemCode': return 'Item Code';
                        case 'previousCount': return 'Previous Count';
                        case 'actualCount': return 'Actual Count';
                        case 'variance': return 'Variance';
                        default: return key;
                    }
                })
            ];

            // Item data based on selected columns
            selectedItems.forEach(item => {
                const rowData = [];
                if (selectedColumns.itemName) rowData.push(item.itemName);
                if (selectedColumns.itemCode) rowData.push(item.itemCode);
                if (selectedColumns.previousCount) rowData.push(item.previousCount);
                if (selectedColumns.actualCount) rowData.push(item.actualCount);
                if (selectedColumns.variance) rowData.push(item.variance);
                excelData.push(rowData);
            });

            const response = await fetch('/api/generate-excel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ data: excelData })
            });

            if (!response.ok) {
                alert("Failed to generate preview. Server error.");
                return;
            }

            const excelBlob = await response.blob();
            const url = URL.createObjectURL(excelBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `Packaging_Inventory_Preview_${new Date().toISOString().slice(0, 10)}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            closePreviewSelectionModal();
            alert("Preview generated. Check your downloads.");
        });


        // --- IMPORT FILE HANDLING ---
        importCountsBtn.addEventListener('click', () => {
            importCountsFile.click();
        });

        importCountsFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Get as array of arrays

                    if (json.length < 2) { // Expect at least headers + 1 row of data
                        alert("The imported file does not contain enough data.");
                        return;
                    }

                    // Assuming first row is headers based on your desired format
                    const headers = json[0];
                    const dataRows = json.slice(1);

                    const importMapping = {
                        'Item Name': 'itemName',
                        'Item Code': 'itemCode',
                        'Previous Count': 'previousCount',
                        'Actual Count': 'actualCount'
                    };

                    const newItems = [];
                    let hasValidData = false;

                    dataRows.forEach((row, rowIndex) => {
                        const item = {};
                        let rowHasData = false;
                        headers.forEach((header, colIndex) => {
                            const propName = importMapping[header.trim()];
                            if (propName) {
                                let value = row[colIndex];
                                if (propName === 'previousCount' || propName === 'actualCount') {
                                    value = parseInt(value) || 0; // Ensure it's a number
                                }
                                item[propName] = value;
                                if (value !== undefined && value !== null && value !== '' && (typeof value !== 'number' || value !== 0)) {
                                    rowHasData = true; // Mark row as having meaningful data
                                }
                            }
                        });

                        if (rowHasData && item.itemName && item.itemCode) { // Only add if it has name and code
                            item.id = Date.now() + rowIndex; // Simple ID generation for imported items
                            item.variance = (item.actualCount || 0) - (item.previousCount || 0);
                            newItems.push(item);
                            hasValidData = true;
                        }
                    });

                    if (hasValidData) {
                        items = [...items, ...newItems]; // Add imported items to existing
                        saveToLocal();
                        renderTable();
                        alert("Countsheet imported successfully!");
                    } else {
                        alert("No valid item data found in the imported countsheet.");
                    }

                } catch (error) {
                    console.error("Error processing Countsheet Excel file:", error);
                    alert("Failed to import countsheet. Please ensure it's a valid Excel file and matches the expected format. Error: " + error.message);
                }
            };

            reader.onerror = () => {
                alert("Failed to read the countsheet file. Please try again.");
            };

            reader.readAsArrayBuffer(file);
            event.target.value = '';
        });
        // --- END IMPORT FILE HANDLING ---


        setDateBtn.addEventListener('click', () => {
            const today = new Date();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const yyyy = today.getFullYear();
            dateShiftInput.value = `${mm}/${dd}/${yyyy}`;
        });

        setTimeBtn.addEventListener('click', () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            timeCountedInput.value = `${hours}:${minutes}`;
        });

        setTimeBtn.click(); // Call on page load to set initial time
        setDateBtn.click(); // Call on page load to set initial date

        loadFromLocal();
        renderTable();
    </script>
</body>
</html>