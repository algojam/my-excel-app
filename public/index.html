<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Packaging Materials Inventory</title>
    
    <link href="/css/tailwind.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <link href="/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto Slab', serif; background-color: white; }
        .handwritten { font-family: 'Courier New', monospace; font-style: italic; font-weight: 600; letter-spacing: 0.03em; }
        .italic { font-style: italic; }
        input, button, textarea, select { font-family: 'Roboto Slab', serif; }

        .inventory-table-container {
            overflow-x: auto;
        }
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            /* Add any custom table styles you had */
        }
        .inventory-table th, .inventory-table td {
            border: 1px solid #e2e8f0; /* Tailwind's border-gray-200 */
            padding: 8px;
            text-align: left;
            white-space: nowrap; /* Prevent wrapping in cells */
        }
        .inventory-table th {
            background-color: #f8fafc; /* Tailwind's bg-gray-50 */
            font-weight: 600;
        }
        .inventory-table tbody tr:nth-child(even) {
            background-color: #f0f4f8; /* A light gray for even rows */
        }
        .inventory-table tbody tr:hover {
            background-color: #e2e8f0; /* Highlight on hover */
        }

        /* Custom styles for the count input */
        .count-input-group {
            display: flex;
            align-items: center;
            gap: 4px; /* Space between inputs and button */
        }
        .count-display-field {
            flex-grow: 1; /* Allow input to take available space */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div class="container mx-auto p-6 bg-white rounded-lg shadow-md max-w-5xl mt-8 mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">Packaging Materials Inventory</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label for="dateShift" class="block text-gray-700 text-sm font-bold mb-2">Date / Shift:</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="dateShift" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline handwritten" placeholder="MM/DD/YYYY">
                    <button id="setDateBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                </div>
            </div>
            <div>
                <label for="timeCounted" class="block text-gray-700 text-sm font-bold mb-2">TIME COUNTED:</label>
                <div class="flex items-center space-x-2">
                    <input type="text" id="timeCounted" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline handwritten" placeholder="HH:MM">
                    <button id="setTimeBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        <i class="fas fa-clock"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="mb-6 text-center">
            <button id="addNewBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg focus:outline-none focus:shadow-outline transition duration-150 ease-in-out transform hover:scale-105">
                <i class="fas fa-plus-circle mr-2"></i>Add New Item
            </button>
        </div>

        <div class="inventory-table-container mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Current Inventory</h2>
            <table id="inventoryTable" class="inventory-table shadow-md rounded-lg overflow-hidden">
                <thead>
                    <tr>
                        <th class="py-3 px-4 uppercase text-xs text-gray-600 border-b">Item Code</th>
                        <th class="py-3 px-4 uppercase text-xs text-gray-600 border-b">Count</th>
                        <th class="py-3 px-4 uppercase text-xs text-gray-600 border-b">Remarks</th>
                        <th class="py-3 px-4 uppercase text-xs text-gray-600 border-b">Action</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div class="mt-8 flex flex-wrap gap-4 justify-center border-t pt-4">
            <input type="file" id="importFile" accept=".xls,.xlsx" class="hidden">
            <button id="importBtn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                <i class="fas fa-file-import mr-2"></i>Import Countsheet
            </button>
            <button id="exportBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                <i class="fas fa-file-export mr-2"></i>Generate Excel Report
            </button>
            <button id="clearDataBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                <i class="fas fa-trash-alt mr-2"></i>Clear All Data
            </button>
            <button id="previewBtn" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                <i class="fas fa-eye mr-2"></i>Preview
            </button>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white border border-gray-400 rounded-md shadow-lg w-full max-w-md p-6 relative font-sans">
            <button id="closeModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl leading-none">
                &times;
            </button>
            <h2 id="modalTitle" class="text-lg font-bold mb-4 uppercase">Add New Item</h2>
            <div class="mb-4">
                <label for="itemCode" class="block text-gray-700 text-sm font-bold mb-2">Item Code:</label>
                <input type="text" id="itemCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter Item Code">
            </div>
            <div class="mb-4">
                <label for="itemCount" class="block text-gray-700 text-sm font-bold mb-2">Count (comma-separated):</label>
                <input type="text" id="itemCount" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., 10,20,30">
            </div>
            <div class="mb-4">
                <label for="itemRemarks" class="block text-gray-700 text-sm font-bold mb-2">Remarks (comma-separated):</label>
                <input type="text" id="itemRemarks" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., Good,Damaged">
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button id="cancelBtn" class="bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Cancel
                </button>
                <button id="saveBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Save Item
                </button>
            </div>
        </div>
    </div>

    <div id="previewSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white border border-gray-400 rounded-md shadow-lg w-full max-w-lg p-6 relative font-sans">
            <button id="closePreviewSelectionModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl leading-none">
                &times;
            </button>
            <h2 class="text-lg font-bold mb-4 uppercase">Select Items for Preview</h2>
            <div id="previewCheckboxes" class="mb-4 max-h-64 overflow-y-auto border p-3 rounded">
                </div>
            <div class="flex justify-end gap-2 mt-6">
                <button id="cancelPreviewBtn" class="bg-gray-400 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Cancel
                </button>
                <button id="generatePreviewBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Generate Preview
                </button>
            </div>
        </div>
    </div>

    <script>
        const dateShiftInput = document.getElementById('dateShift');
        const timeCountedInput = document.getElementById('timeCounted');
        const setDateBtn = document.getElementById('setDateBtn');
        const setTimeBtn = document.getElementById('setTimeBtn');

        const addNewBtn = document.getElementById('addNewBtn');
        const inventoryTableBody = document.querySelector('#inventoryTable tbody');

        const modal = document.getElementById("modal");
        const modalTitle = document.getElementById("modalTitle");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const itemCodeInput = document.getElementById("itemCode");
        const itemCountInput = document.getElementById("itemCount");
        const itemRemarksInput = document.getElementById("itemRemarks");
        const saveBtn = document.getElementById("saveBtn");
        const cancelBtn = document.getElementById("cancelBtn");

        const previewBtn = document.getElementById('previewBtn');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const exportBtn = document.getElementById('exportBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');

        const previewSelectionModal = document.getElementById('previewSelectionModal');
        const previewCheckboxes = document.getElementById('previewCheckboxes');
        const generatePreviewBtn = document.getElementById('generatePreviewBtn');
        const cancelPreviewBtn = document.getElementById('cancelPreviewBtn');
        const closePreviewSelectionModalBtn = document.getElementById('closePreviewSelectionModalBtn');


        let inventoryData = [];
        let editIndex = null;

        // --- Modal Functions ---
        function openModal(index) {
            itemCodeInput.value = '';
            itemCountInput.value = '';
            itemRemarksInput.value = '';

            if (index !== null) {
                modalTitle.textContent = "Edit Item";
                const item = inventoryData[index];
                itemCodeInput.value = item.code;
                itemCountInput.value = item.count.join(',');
                itemRemarksInput.value = item.remarks.join(',');
                editIndex = index;
            } else {
                modalTitle.textContent = "Add New Item";
                editIndex = null;
            }
            modal.classList.remove("hidden");
            setTimeout(() => { itemCodeInput.focus(); }, 50); // Focus after modal is visible
        }

        function closeModal() {
            modal.classList.add("hidden");
            editIndex = null;
            itemCodeInput.value = '';
            itemCountInput.value = '';
            itemRemarksInput.value = '';
            renderTable(); // Re-render table to ensure any changes are reflected
        }

        function openPreviewSelectionModal() {
            previewCheckboxes.innerHTML = ''; // Clear previous checkboxes
            if (inventoryData.length === 0) {
                alert("No items to preview. Please add items first.");
                return;
            }
            inventoryData.forEach((item, index) => {
                const div = document.createElement('div');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `previewItem${index}`;
                checkbox.value = index;
                checkbox.checked = true; // Default to selected

                const label = document.createElement('label');
                label.htmlFor = `previewItem${index}`;
                label.textContent = `${item.code} - ${item.count.join(', ')}`;
                label.classList.add('ml-2');

                div.appendChild(checkbox);
                div.appendChild(label);
                previewCheckboxes.appendChild(div);
            });
            previewSelectionModal.classList.remove('hidden');
        }

        function closePreviewSelectionModal() {
            previewSelectionModal.classList.add('hidden');
            // No need to renderTable here unless preview logic affects main table
        }
        // --- END Modal Functions ---


        // --- Core Application Logic ---
        function saveToLocal() {
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            localStorage.setItem('dateShift', dateShiftInput.value);
            localStorage.setItem('timeCounted', timeCountedInput.value);
        }

        function loadFromLocal() {
            const storedData = localStorage.getItem('inventoryData');
            const storedDate = localStorage.getItem('dateShift');
            const storedTime = localStorage.getItem('timeCounted');
            if (storedData) {
                inventoryData = JSON.parse(storedData);
            }
            if (storedDate) {
                dateShiftInput.value = storedDate;
            }
            if (storedTime) {
                timeCountedInput.value = storedTime;
            }
        }

        function renderTable() {
            inventoryTableBody.innerHTML = '';
            if (inventoryData.length === 0) {
                const row = inventoryTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 4;
                cell.textContent = 'No items in inventory. Click "Add New Item" to start.';
                cell.classList.add('text-center', 'italic', 'py-4', 'text-gray-500');
                return;
            }

            inventoryData.forEach((item, index) => {
                const row = inventoryTableBody.insertRow();
                row.classList.add('hover:bg-gray-50');

                row.insertCell().textContent = item.code;
                row.insertCell().textContent = item.count.join(', ');
                row.insertCell().textContent = item.remarks.join(', ');

                const actionCell = row.insertCell();
                actionCell.classList.add('flex', 'space-x-2', 'py-2');

                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-700', 'text-white', 'py-1', 'px-2', 'rounded', 'focus:outline-none', 'focus:shadow-outline');
                editBtn.title = 'Edit Item';
                editBtn.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent row click from triggering
                    openModal(index);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.classList.add('bg-red-500', 'hover:bg-red-700', 'text-white', 'py-1', 'px-2', 'rounded', 'focus:outline-none', 'focus:shadow-outline');
                deleteBtn.title = 'Delete Item';
                deleteBtn.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent row click from triggering
                    if (confirm(`Are you sure you want to delete item: ${item.code}?`)) {
                        inventoryData.splice(index, 1);
                        saveToLocal();
                        renderTable();
                    }
                });

                actionCell.appendChild(editBtn);
                actionCell.appendChild(deleteBtn);
            });
        }
        // --- END Core Application Logic ---


        // --- Event Listeners ---
        addNewBtn.addEventListener("click", () => {
            openModal(null); // Open modal for adding new item
        });

        saveBtn.addEventListener("click", () => {
            const code = itemCodeInput.value.trim();
            const countStr = itemCountInput.value.trim();
            const remarksStr = itemRemarksInput.value.trim();

            if (!code) {
                alert("Item Code cannot be empty.");
                return;
            }

            // Parse count and remarks, removing empty strings
            const count = countStr ? countStr.split(',').map(s => s.trim()).filter(s => s !== '') : [];
            const remarks = remarksStr ? remarksStr.split(',').map(s => s.trim()).filter(s => s !== '') : [];

            if (editIndex !== null) {
                // Update existing item
                inventoryData[editIndex] = { code, count, remarks };
            } else {
                // Add new item
                inventoryData.push({ code, count, remarks });
            }
            saveToLocal();
            closeModal(); // Close modal and re-render table
        });

        cancelBtn.addEventListener("click", closeModal);
        closeModalBtn.addEventListener("click", closeModal);


        importBtn.addEventListener('click', () => {
            importFile.click();
        });

        importFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length > 1) { // Assuming first row is header
                        const importedData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row[0]) { // Ensure Item Code is not empty
                                const code = String(row[0]).trim();
                                const count = row[1] ? String(row[1]).split(',').map(s => s.trim()).filter(s => s !== '') : [];
                                const remarks = row[2] ? String(row[2]).split(',').map(s => s.trim()).filter(s => s !== '') : [];
                                importedData.push({ code, count, remarks });
                            }
                        }
                        if (importedData.length > 0) {
                            inventoryData = [...inventoryData, ...importedData]; // Append imported data
                            saveToLocal();
                            renderTable();
                            alert("Countsheet imported successfully!");
                        } else {
                            alert("No valid item data found in the imported countsheet.");
                        }

                    } else {
                        alert("No valid item data found in the imported countsheet.");
                    }

                } catch (error) {
                    console.error("Error processing Countsheet Excel file:", error);
                    alert("Failed to import countsheet. Please ensure it's a valid Excel file and matches the expected format. Error: " + error.message);
                }
            };

            reader.onerror = () => {
                alert("Failed to read the countsheet file. Please try again.");
            };

            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Clear the file input
        });

        // --- EXCEL EXPORT (SERVERLESS FUNCTION) ---
        exportBtn.addEventListener('click', async () => {
            const dateShift = dateShiftInput.value;
            const timeCounted = timeCountedInput.value;

            // Prepare data for the serverless function
            const dataToExport = {
                dateShift,
                timeCounted,
                inventoryData: inventoryData
            };

            try {
                const response = await fetch('/api/generate-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToExport)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    // Ensure the filename is dynamic based on current date/time
                    const filename = `inventory_report_${dateShift.replace(/\//g, '-')}_${timeCounted.replace(/:/g, '-')}.xlsx`;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    alert('Excel report generated successfully!');
                } else {
                    const errorText = await response.text();
                    alert(`Failed to generate Excel report: ${errorText}`);
                }
            } catch (error) {
                console.error('Error generating Excel report:', error);
                alert('An error occurred while generating the Excel report.');
            }
        });
        // --- END EXCEL EXPORT ---

        clearDataBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear all inventory data? This cannot be undone.")) {
                inventoryData = [];
                saveToLocal();
                renderTable();
                alert("All inventory data cleared.");
            }
        });

        previewBtn.addEventListener('click', openPreviewSelectionModal);
        generatePreviewBtn.addEventListener('click', () => {
            const selectedIndices = Array.from(previewCheckboxes.querySelectorAll('input[type="checkbox"]:checked'))
                                       .map(checkbox => parseInt(checkbox.value));
            
            if (selectedIndices.length === 0) {
                alert("Please select at least one item to preview.");
                return;
            }

            const previewData = selectedIndices.map(index => inventoryData[index]);

            // --- Client-side Preview Generation (similar to old export logic, but for display) ---
            const workbook = XLSX.utils.book_new();
            const worksheetData = [
                ['Date/Shift:', dateShiftInput.value],
                ['Time Counted:', timeCountedInput.value],
                [], // Empty row for spacing
                ['Item Code', 'Count', 'Remarks']
            ];

            previewData.forEach(item => {
                worksheetData.push([item.code, item.count.join(', '), item.remarks.join(', ')]);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(workbook, worksheet, "Preview");

            // Convert to base64 for display or offer download option (example below)
            const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);

            // Open in a new tab (or you could embed it, or offer download)
            window.open(url, '_blank');
            URL.revokeObjectURL(url); // Clean up URL object

            closePreviewSelectionModal();
            alert("Preview generated. Check the new tab/window.");
        });

        cancelPreviewBtn.addEventListener('click', closePreviewSelectionModal);
        closePreviewSelectionModalBtn.addEventListener('click', closePreviewSelectionModal);

        // Set initial date and time on load
        setDateBtn.addEventListener('click', () => {
            const today = new Date();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const yyyy = today.getFullYear();
            dateShiftInput.value = `${mm}/${dd}/${yyyy}`;
        });

        setTimeBtn.addEventListener('click', () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            timeCountedInput.value = `${hours}:${minutes}`;
        });

        setTimeBtn.click(); // Call on page load to set initial time
        setDateBtn.click(); // Call on page load to set initial date

        loadFromLocal();
        renderTable();
    </script>
</body>
</html>