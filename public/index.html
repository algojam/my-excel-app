<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Packaging Materials Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <style>
        body {
            font-family: 'Roboto Slab', serif;
            background-color: white;
            color: #1a202c; /* Tailwind gray-900 */
        }
        .handwritten {
            font-family: 'Courier New', monospace;
            font-style: italic;
            font-weight: 600;
            letter-spacing: 0.03em;
        }
        .italic {
            font-style: italic;
        }
        input, button, textarea, select {
            font-family: 'Roboto Slab', serif;
        }

        .inventory-table-container {
            overflow-x: auto;
        }
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
        }
        .inventory-table th, .inventory-table td {
            border: 1px solid #cbd5e0; /* Tailwind gray-300 */
            padding: 0.5rem 0.75rem;
            text-align: left;
            vertical-align: top;
        }
        .inventory-table th {
            background-color: #e2e8f0; /* Tailwind blue-gray-200 */
            font-weight: 700;
            color: #2d3748; /* Tailwind gray-700 */
            text-align: center;
        }
        .inventory-table td {
            background-color: white;
        }
        .inventory-table tr:nth-child(even) td {
            background-color: #f7fafc; /* Tailwind gray-50 */
        }

        /* Custom styling for remarks-based rows */
        .row-hold td { background-color: #fefcbf; /* Tailwind yellow-100 */ }
        .row-approved td { background-color: #fee2e2; /* Tailwind red-100 (assuming red for approved, adjust if needed) */ }
        .row-first-out td { background-color: #d1fae5; /* Tailwind green-100 */ }

        /* Styling for the Add Item Form */
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .form-field {
            flex: 1;
            min-width: 150px; /* Minimum width for fields */
        }
        .form-field label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }
        .form-field input[type="text"],
        .form-field textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.25rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-field input[type="text"]:focus,
        .form-field textarea:focus {
            border-color: #63b3ed; /* Tailwind blue-400 */
        }
        .form-field textarea {
            resize: vertical;
            min-height: 40px; /* Adjusted min-height for count breakdown */
        }
        .form-field-buttons {
            display: flex;
            gap: 0.5rem;
            flex-grow: 0;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-lg p-6">
        <h1 class="text-3xl font-extrabold text-center mb-6 text-gray-800">PACKAGING MATERIALS DAILY COUNT SHEET</h1>

        <div class="mb-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="flex items-center gap-2">
                    <label for="dateShift" class="font-semibold text-gray-700">Date / Shift :</label>
                    <input type="text" id="dateShift" class="flex-grow handwritten p-1 border-b border-gray-400 focus:border-blue-500 outline-none text-gray-800" readonly>
                    <button id="setDateBtn" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition duration-150">
                        <i class="fas fa-calendar-alt"></i> Set Date
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <label for="timeCounted" class="font-semibold text-gray-700">TIME COUNTED:</label>
                    <input type="text" id="timeCounted" class="flex-grow handwritten p-1 border-b border-gray-400 focus:border-blue-500 outline-none text-gray-800" readonly>
                    <button id="setTimeBtn" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 transition duration-150">
                        <i class="fas fa-clock"></i> Set Time
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <label for="shiftSelect" class="font-semibold text-gray-700">Shift:</label>
                <select id="shiftSelect" class="p-1 border-b border-gray-400 focus:border-blue-500 outline-none text-gray-800 rounded-md">
                    <option value="Day Shift">Day Shift</option>
                    <option value="Night Shift">Night Shift</option>
                </select>
            </div>
        </div>

        <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h2 class="text-xl font-bold mb-4 text-gray-700">Add New Item</h2>
            <div class="form-row">
                <div class="form-field flex-grow">
                    <label for="itemCode">Item Code:</label>
                    <input type="text" id="itemCode" placeholder="Enter item code (e.g., PM001)" class="w-full">
                </div>
                <div class="form-field flex-grow-2">
                    <label for="countBreakdown">Actual Count Breakdown:</label>
                    <textarea id="countBreakdown" rows="2" placeholder="e.g., 10×5, 20+5, 10-2" class="w-full"></textarea>
                    <p class="text-sm text-gray-500 mt-1">Use comma or new line for multiple counts. Use × for multiplication, + for addition, - for subtraction.</p>
                </div>
                <div class="form-field flex-grow">
                    <label for="remarks">Remarks (optional):</label>
                    <textarea id="remarks" rows="2" placeholder="e.g., hold, approved, first out" class="w-full"></textarea>
                    <p class="text-sm text-gray-500 mt-1">Separate multiple remarks with a comma or new line.</p>
                </div>
                <div class="form-field-buttons items-end">
                    <button id="addItemBtn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-150 whitespace-nowrap">
                        <i class="fas fa-plus-circle"></i> Add Item
                    </button>
                </div>
            </div>
        </div>

        <div class="inventory-table-container shadow-md rounded-lg mb-8">
            <table id="inventoryTable" class="inventory-table">
                <thead>
                    <tr>
                        <th>ITEM CODE</th>
                        <th>ACTUAL COUNT BREAKDOWN</th>
                        <th>TOTAL</th>
                        <th>REMARKS</th>
                        <th class="w-24">ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-center gap-4 p-4 bg-white rounded-lg">
            <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                <button id="exportBtn" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition duration-150 flex items-center justify-center gap-2">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <label for="importFile" class="bg-purple-600 text-white px-6 py-3 rounded-md hover:bg-purple-700 transition duration-150 flex items-center justify-center gap-2 cursor-pointer whitespace-nowrap">
                    <i class="fas fa-upload"></i> Import Countsheet
                    <input type="file" id="importFile" accept=".xlsx,.xls" class="hidden">
                </label>
            </div>
            <button id="clearAllBtn" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition duration-150 flex items-center justify-center gap-2 w-full md:w-auto">
                <i class="fas fa-trash-alt"></i> Clear All Data
            </button>
        </div>
    </div>

    <script>
        const itemCodeInput = document.getElementById('itemCode');
        const countBreakdownInput = document.getElementById('countBreakdown');
        const remarksInput = document.getElementById('remarks');
        const addItemBtn = document.getElementById('addItemBtn');
        const inventoryTableBody = document.querySelector('#inventoryTable tbody');
        const exportBtn = document.getElementById('exportBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const dateShiftInput = document.getElementById('dateShift');
        const timeCountedInput = document.getElementById('timeCounted');
        const setDateBtn = document.getElementById('setDateBtn');
        const setTimeBtn = document.getElementById('setTimeBtn');
        const shiftSelect = document.getElementById('shiftSelect');
        const importFile = document.getElementById('importFile');

        let inventoryData = [];

        // Helper function to calculate total from breakdown
        function calculateTotal(countArr) {
            if (!Array.isArray(countArr)) {
                return 0;
            }
            let total = 0;
            countArr.forEach(part => {
                const trimmedVal = part.trim();
                if (trimmedVal === "") {
                    return;
                }
                if (trimmedVal.includes('×')) {
                    const parts = trimmedVal.split('×');
                    if (parts.length === 2) {
                        const num1 = parseFloat(parts[0].trim());
                        const num2 = parseFloat(parts[1].trim());
                        if (!isNaN(num1) && !isNaN(num2)) {
                            total += (num1 * num2);
                        }
                    }
                } else if (trimmedVal.includes('+')) {
                    const sumParts = trimmedVal.split('+').map(p => parseFloat(p.trim()));
                    const sum = sumParts.reduce((acc, val) => acc + (isNaN(val) ? 0 : val), 0);
                    total += sum;
                } else if (trimmedVal.includes('-')) {
                    const subParts = trimmedVal.trim().split('-');
                    if (subParts.length > 0) {
                        const initialValue = parseFloat(subParts[0].trim());
                        if (!isNaN(initialValue)) {
                            let subTotal = initialValue;
                            for (let i = 1; i < subParts.length; i++) {
                                const val = parseFloat(subParts[i].trim());
                                if (!isNaN(val)) {
                                    subTotal -= val;
                                }
                            }
                            total += subTotal;
                        }
                    }
                } else {
                    const n = parseFloat(trimmedVal);
                    if (!isNaN(n)) {
                        total += n;
                    }
                }
            });
            return total;
        }

        // Helper function to generate Excel formula string
        function generateExcelFormula(countArr) {
            if (!Array.isArray(countArr) || countArr.length === 0) {
                return "0";
            }

            const parsedParts = countArr.map(part => {
                const trimmedVal = part.trim();
                if (trimmedVal === "") {
                    return "0";
                }
                let formattedPart = trimmedVal.replace(/×/g, '*');

                // Wrap sums/subtractions in parentheses to ensure correct order of operations in Excel
                if (formattedPart.includes('+') || formattedPart.includes('-')) {
                    return `(${formattedPart})`;
                }
                return formattedPart;
            });

            // Join all parts with '+' for the final Excel formula
            return parsedParts.join('+');
        }

        // Render table rows
        function renderTable() {
            inventoryTableBody.innerHTML = '';
            inventoryData.forEach((item, index) => {
                const row = inventoryTableBody.insertRow();
                let rowClass = '';
                if (item.remarks.some(r => r.toLowerCase().includes("hold"))) {
                    rowClass = 'row-hold';
                } else if (item.remarks.some(r => r.toLowerCase().includes("approved"))) {
                    rowClass = 'row-approved';
                } else if (item.remarks.some(r => r.toLowerCase().includes("first out") || r.toLowerCase().includes("old"))) {
                    rowClass = 'row-first-out';
                }
                row.className = rowClass;

                row.insertCell(0).textContent = item.code;
                row.insertCell(1).textContent = item.count.join(' | '); // Display as string
                row.insertCell(2).textContent = calculateTotal(item.count); // Display calculated total
                row.insertCell(3).textContent = item.remarks.join(' | '); // Display as string

                const actionsCell = row.insertCell(4);
                actionsCell.className = "text-center";
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt text-red-500 hover:text-red-700"></i>';
                deleteBtn.className = 'p-2 rounded-md transition duration-150';
                deleteBtn.onclick = () => deleteItem(index);
                actionsCell.appendChild(deleteBtn);
            });
            saveToLocal();
        }

        // Add new item
        addItemBtn.addEventListener('click', () => {
            const code = itemCodeInput.value.trim();
            const count = countBreakdownInput.value.split(/[\n,]+/).map(s => s.trim()).filter(s => s !== '');
            const remarks = remarksInput.value.split(/[\n,]+/).map(s => s.trim()).filter(s => s !== '');

            if (code && count.length > 0) {
                inventoryData.push({ code, count, remarks });
                renderTable();
                itemCodeInput.value = '';
                countBreakdownInput.value = '';
                remarksInput.value = '';
            } else {
                alert('Please enter Item Code and at least one Count Breakdown.');
            }
        });

        // Delete item
        function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                inventoryData.splice(index, 1);
                renderTable();
            }
        }

        // Clear all data
        clearAllBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear ALL inventory data? This cannot be undone.')) {
                inventoryData = [];
                renderTable();
            }
        });

        // Local Storage functions
        function saveToLocal() {
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            localStorage.setItem('dateShift', dateShiftInput.value);
            localStorage.setItem('timeCounted', timeCountedInput.value);
            localStorage.setItem('shiftType', shiftSelect.value);
        }

        function loadFromLocal() {
            const savedData = localStorage.getItem('inventoryData');
            if (savedData) {
                inventoryData = JSON.parse(savedData);
            }
            const savedDate = localStorage.getItem('dateShift');
            if (savedDate) {
                dateShiftInput.value = savedDate;
            }
            const savedTime = localStorage.getItem('timeCounted');
            if (savedTime) {
                timeCountedInput.value = savedTime;
            }
            const savedShift = localStorage.getItem('shiftType');
            if (savedShift) {
                shiftSelect.value = savedShift;
            }
        }

        // --- START EXPORT TO EXCEL (UPDATED FOR NODE.JS SERVER) ---
        exportBtn.addEventListener('click', async () => {
            const dateShift = dateShiftInput.value.trim();
            const timeCounted = timeCountedInput.value.trim();
            const shiftType = shiftSelect.value;

            try {
                // Magpadala ng data sa iyong Node.js server endpoint
                const response = await fetch('/export-excel', { // Ito ang endpoint sa iyong server.js
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inventoryData: inventoryData, // Ang iyong array ng item objects
                        dateShift: dateShift,
                        timeCounted: timeCounted,
                        shiftType: shiftType
                    }),
                });

                if (!response.ok) {
                    // Handle specific HTTP errors from the server
                    const errorText = await response.text(); // Basahin ang error message mula sa server
                    throw new Error(`Server error! status: ${response.status}, message: ${errorText}`);
                }

                // Tanggapin ang Excel file na ipinadala ng server bilang Blob
                const blob = await response.blob();
                // Basahin ang filename mula sa Content-Disposition header ng server response
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'packaging_materials_count.xlsx'; // Default filename
                if (contentDisposition && contentDisposition.includes('filename=')) {
                    // Extract filename from header, removing surrounding quotes if present
                    filename = contentDisposition.split('filename=')[1].replace(/"/g, '');
                }

                // Lumikha ng URL para sa Blob at i-trigger ang download
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename; // Gamitin ang filename mula sa server
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url); // I-release ang object URL
                alert("Excel file generated and downloaded!");

            } catch (error) {
                console.error('Error exporting Excel:', error);
                alert('Failed to export Excel file. Please try again. Error: ' + error.message);
            }
        });
        // --- END EXPORT TO EXCEL (UPDATED FOR NODE.JS SERVER) ---


        // --- IMPORT FILE HANDLING (still client-side using SheetJS) ---
        importFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Assuming specific columns for import: ITEM CODE, ACTUAL COUNT BREAKDOWN, REMARKS
                    // Adjust column indices based on your Excel file structure
                    const headerRow = json[0]; // Assuming first row is header
                    const itemCodeCol = headerRow.indexOf('ITEM CODE');
                    const countBreakdownCol = headerRow.indexOf('ACTUAL COUNT BREAKDOWN');
                    const remarksCol = headerRow.indexOf('REMARKS');

                    if (itemCodeCol === -1 || countBreakdownCol === -1) {
                        alert("Required columns (ITEM CODE, ACTUAL COUNT BREAKDOWN) not found in the Excel file.");
                        return;
                    }

                    const importedItems = [];
                    for (let i = 1; i < json.length; i++) { // Start from second row (after header)
                        const rowData = json[i];
                        const code = rowData[itemCodeCol] ? String(rowData[itemCodeCol]).trim() : '';
                        let count = [];
                        if (rowData[countBreakdownCol]) {
                            // Split by common delimiters like comma, newline, or pipe
                            count = String(rowData[countBreakdownCol]).split(/[,|\n]+/).map(s => s.trim()).filter(s => s !== '');
                        }
                        let remarks = [];
                        if (remarksCol !== -1 && rowData[remarksCol]) {
                            remarks = String(rowData[remarksCol]).split(/[,|\n]+/).map(s => s.trim()).filter(s => s !== '');
                        }

                        if (code && count.length > 0) {
                            importedItems.push({ code, count, remarks });
                        }
                    }

                    if (importedItems.length > 0) {
                        inventoryData = importedItems; // Replace current data or append, depending on preference
                        renderTable();
                        alert("Countsheet imported successfully!");
                    } else {
                        alert("No valid item data found in the imported countsheet.");
                    }

                } catch (error) {
                    console.error("Error processing Countsheet Excel file:", error);
                    alert("Failed to import countsheet. Please ensure it's a valid Excel file and matches the expected format. Error: " + error.message);
                }
            };

            reader.onerror = () => {
                alert("Failed to read the countsheet file. Please try again.");
            };

            reader.readAsArrayBuffer(file);
            event.target.value = ''; // Clear the input field
        });
        // --- END IMPORT FILE HANDLING ---


        setDateBtn.addEventListener('click', () => {
            const today = new Date();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const yyyy = today.getFullYear();
            dateShiftInput.value = `${mm}/${dd}/${yyyy}`;
        });

        setTimeBtn.addEventListener('click', () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            timeCountedInput.value = `${hours}:${minutes}`;
        });

        // Set initial date and time on load
        setTimeBtn.click();
        setDateBtn.click();

        // Load data and render table on page load
        loadFromLocal();
        renderTable();
    </script>
</body>
</html>